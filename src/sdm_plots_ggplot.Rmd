---
title: "sdm_plots_ggplot"
author: "Leonardo Feitosa"
date: "28/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(raster)
library(patchwork)
library(rnaturalearth)
library(MetBrewer)
```

```{r}
# Set directories
basedir <- "G:/Meu Drive/S. tudes/data/"
rasterdir <- file.path(basedir, "raster_layers") # calls raster layers
presdir <- file.path(basedir, "present") # calls present data from raster files
futdir <- file.path(basedir, "future") # calls future data from raster files
outdir <- file.path(basedir, "outputs") # sends plots to the output folder
occurdir <- file.path(basedir, "occurrences") # calls the occurrence data
vardir <- file.path(basedir, "variables") # calls socioeconomic and fisheries variables
shapedir <- file.path(basedir, "shape_files") # calls the shapefiles
resultdir <- file.path("results")
```

```{r}
# test
df_orig <- raster::raster(file.path(presdir, "Present.Benthic.Mean.Depth.Dissolved.oxygen.Mean.tif")) 
```


```{r}
## Read in the data from the test models for variable importance
vars <- list.files(file.path(outdir, "tests_present"),
                   pattern = ".csv",
                   full.names = TRUE)

tbl <- sapply(vars, read.csv, simplify = FALSE, sep = ";")

vars_tbl <- tbl %>%
  bind_rows() 

#### Wrangling the data to create a long table
vars_long <- vars_tbl %>% 
  pivot_longer(cols = bioclim:maxent,
               names_to = "algorithm",
               values_to = "auc")

## Read in the data from final model
model_final <- read_csv(file.path(outdir, "auc_present.csv")) %>% 
  pivot_longer(cols = bioclim:maxent,
               names_to = "algorithm",
               values_to = "auc") %>% 
  mutate(variable = "full_model") %>% 
  relocate(variable, .before = algorithm)
```

```{r}
## Compute summary stats
vars_summary <- vars_long %>% 
  group_by(variable, algorithm) %>% 
  summarise(mean_auc = mean(auc),
            sd_auc = sd(auc))

## Summary stats of final model
final_summary <- model_final %>% 
  group_by(variable, algorithm) %>% 
  summarise(mean_auc = mean(auc),
            sd_auc = sd(auc))

summary_df <- full_join(vars_summary, final_summary, by = c("variable", "algorithm", "mean_auc", "sd_auc")) 


summary_df_wide <- summary_df %>% 
  pivot_wider(names_from = starts_with(c("algorithm")),
              values_from = ends_with(c("auc"))) %>% 
  relocate(sd_auc_bioclim, .after = mean_auc_bioclim) %>% 
  relocate(sd_auc_gower, .after = mean_auc_gower) %>% 
  relocate(sd_auc_maha, .after = mean_auc_maha) %>% 
  relocate(sd_auc_maxent, .after = mean_auc_maxent)

#write_csv(summary_df_wide, path = here::here("data", "outputs", "tests_present", "summary_stats_tests.csv"), col_names = T)
```

```{r, fig.width=7, fig.height=4.5}
summary_df %>% 
    mutate(variable = case_when(
    variable == "mean_surf_temp" ~ "Surface Temperature (mean)",
    variable == "mean_surf_sal" ~ "Surface Salinity (mean)",
    variable == "mean_surf_DO" ~ "Surface Dissolved Oxygen (mean)",
    variable == "mean_surf_curr" ~ "Surface Current (mean)",
    variable == "mean_surf_chla" ~ "Surface Chlorophyll A (mean)",
    variable == "mean_light_bot" ~ "Light at bottom (mean)",
    variable == "mean_cloud" ~ "Cloud cover (mean)",
    variable == "full_model" ~ "Full model",
    variable == "benthic_mean_DO" ~ "Benthic Dissolved Oxygen (mean)",
    variable == "bent_mean_sal" ~ "Benthic Salinity (mean)",
  )) %>% 
  mutate(algorithm = str_to_sentence(algorithm)) %>% 
  mutate(algorithm = case_when(
    algorithm == "Maha" ~ "Mahalanobis",
    TRUE ~ algorithm
  )) %>% 
ggplot() +
  geom_point(aes(x = variable, y = mean_auc, color = algorithm),
             show.legend = F,
             size = 2) +
  geom_linerange(aes(x = variable, ymin = mean_auc - sd_auc, ymax = mean_auc + sd_auc, color = algorithm),
                size = 0.6,
                show.legend = F) +
  facet_wrap(~ algorithm, nrow = 1) +
  labs(x = "",
       y = "Mean AUC") +
  scale_color_manual(values = met.brewer("Java", 4)) +
  scale_y_continuous(breaks = seq(0.6, 1, by = 0.2)) +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 12),
        panel.spacing.x = unit(2, "mm"))


ggsave(file.path(outdir, "variable_test2.png"), width = 7, height = 4.5, dpi = 300)
```


```{r, fig.width=8}
ggplot(data = vars_summary %>% filter(algorithm == "bioclim")) +
  geom_point(aes(x = variable, y = mean_auc, color = algorithm),
             show.legend = F) +
  geom_errorbar(aes(x = variable, ymin = mean_auc - sd_auc, ymax = mean_auc + sd_auc)) +
  geom_hline(yintercept = 0.8204545) +
  scale_y_continuous(breaks = seq(0.6, 1, by = 0.1)) +
  labs(x = "",
       y = "Mean AUC",
       title = "Bioclim") +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"))

ggplot(data = vars_summary %>% filter(algorithm == "maha")) +
  geom_point(aes(x = variable, y = mean_auc, color = algorithm),
             show.legend = F) +
  geom_errorbar(aes(x = variable, ymin = mean_auc - sd_auc, ymax = mean_auc + sd_auc)) +
  geom_hline(yintercept = 0.9917355) +
  labs(x = "",
       y = "Mean AUC",
       title = "Mahalanobis") +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"))

ggplot(data = vars_summary %>% filter(algorithm == "gower")) +
  geom_point(aes(x = variable, y = mean_auc, color = algorithm),
             show.legend = F) +
  geom_errorbar(aes(x = variable, ymin = mean_auc - sd_auc, ymax = mean_auc + sd_auc)) +
  geom_hline(yintercept = 0.9528926) +
  labs(x = "",
       y = "Mean AUC",
       title = "Gower") +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_text(size = 12, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.text.x = element_blank())

ggplot(data = vars_summary %>% filter(algorithm == "maxent")) +
  geom_point(aes(x = variable, y = mean_auc, color = algorithm),
             show.legend = F) +
  geom_errorbar(aes(x = variable, ymin = mean_auc - sd_auc, ymax = mean_auc + sd_auc)) +
  geom_hline(yintercept = 0.9896694) +
  labs(x = "",
       y = "Mean AUC",
       title = "Maxent") +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_text(size = 12, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.title.x = element_blank())
```


## Read back in the rasters written above

```{r}
# ocor dataset
ocor <- read.csv(file.path(occurdir, "occurrence_data.csv"), sep = ";") %>% 
  dplyr::select(long, lat)
# Binary map
#stud_bin_future <- raster::raster(file.path(futdir, "ensemble_stud_binary_future.tif"))
# Probabilty map
#stud_prob_future <- raster::raster(file.path(futdir, "ensemble_stud_prob_future.tif"))

# Binary map
#stud_bin_pres_comp <- raster::raster(file.path(presdir, "ensemble_stud_binary_present_comparison.tif"))
# Probabilty map
#stud_prob_pres_comp <- raster::raster(file.path(presdir, "ensemble_stud_prob_present_comparison.tif"))

# Binary map
stud_bin_pres <- raster::raster(file.path(presdir, "ensemble_stud_binary_present.tif"))
# Probabilty map
stud_prob_pres <- raster::raster(file.path(presdir, "ensemble_stud_prob_present.tif"))

# load shape files
## world countries
world <- ne_countries(scale = "medium", returnclass = "sf")
#read_sf(here::here("data", "shape_files", "world_countries", "World_Countries.shp"))
# Sphyrna tudes IUCN distribution map 
# stud_dist_IUCN <- read_sf(here::here("data", "shape_files", "stud", "data_0.shp")) %>% 
#   as.data.frame()

# Bathymetry layers
#bathy_0 <- read_sf(file.path(shapedir, "ne_10m_bathymetry_L_0.shp"))
bathy_200<-read_sf(file.path(shapedir, "bathymetry", "ne_10m_bathymetry_K_200.shp"))
# bathy_1k <-read_sf(file.path(shapedir, "ne_10m_bathymetry_J_1000.shp"))
# bathy_2k <-read_sf(file.path(shapedir, "ne_10m_bathymetry_I_2000.shp"))
# bathy_3k <-read_sf(file.path(shapedir, "ne_10m_bathymetry_H_3000.shp"))
# bathy_4k <-read_sf(file.path(shapedir, "ne_10m_bathymetry_G_4000.shp"))
# bathy_5k <-read_sf(file.path(shapedir, "ne_10m_bathymetry_F_5000.shp"))
```

```{r}
# Check the CRS for the world and stud_dist_IUCN shape files
world %>% st_crs() # WGS 84, CRS = 4326
#stud_dist_IUCN %>% st_crs() # WGS 84, CRS = 4326
```


```{r}
# Create df from rasters
stud_bin_fut_df <- raster::rasterToPoints(stud_bin_future) %>% 
  as.data.frame() %>% 
  rename(ensemble = ensemble_stud_binary_future)

stud_prob_fut_df <- raster::rasterToPoints(stud_prob_future) %>% 
  as.data.frame() %>% 
  rename(ensemble = ensemble_stud_prob_future)

stud_bin_pres_comp_df <- raster::rasterToPoints(stud_bin_pres_comp) %>% 
  as.data.frame() %>% 
  rename(ensemble = ensemble_stud_binary_present_comparison)

stud_prob_pres_comp_df <- raster::rasterToPoints(stud_prob_pres_comp) %>% 
  as.data.frame() %>%  
  rename(ensemble = ensemble_stud_prob_present_comparison)

stud_bin_pres_df <- raster::rasterToPoints(stud_bin_pres) %>% 
  as.data.frame() %>% 
  rename(ensemble = ensemble_stud_binary_present)

stud_prob_pres_df <- raster::rasterToPoints(stud_prob_pres) %>% 
  as.data.frame() %>% 
  rename(ensemble = ensemble_stud_prob_present)
```

```{r}
# WORK ON TRYING TO PLOT THE S. TUDES DISTRIBUTION MAP FROM IUCN
# ggplot() +
#   geom_sf(data = stud_dist_IUCN)
```

```{r code for plotting a map with bathymetry data}
  # geom_sf(data = bathy_0,
  #         aes(fill = depth)) +
  # geom_sf(data = bathy_200,
  #         aes(fill = depth,
  #             color = depth),
  #         show.legend = F) +
  # geom_sf(data = bathy_1k,
  #         aes(fill = depth,
  #             color = depth),
  #         show.legend = F) +
  # geom_sf(data = bathy_2k,
  #         aes(fill = depth,
  #             color = depth),
  #         show.legend = F) +
  # geom_sf(data = bathy_3k,
  #         aes(fill = depth,
  #             color = depth),
  #         show.legend = F) +
  # geom_sf(data = bathy_5k,
  #         aes(fill = depth,
  #             color = depth),
  #         show.legend = F) +
  # scale_color_gradient(low = "steelblue1", high = "royalblue4",
  #                     breaks = seq(200, 5000, by = 2400),
  #                     labels = c("<200", "2600", "5000")) +
```

```{r}
bathy_200_geo <- bathy_200 %>% 
  st_drop_geometry()
```


```{r}
ggplot(data = bathy_200 %>% ) +
  geom_sf(fill = NA) +
  coord_sf(xlim = c(-120, -20),
           ylim = c(-60, 50),
           expand = FALSE)
```


## Trying to plot rasters in ggplot - Work further on this!
future_comp_bin <- 
```{r, fig.height=9, fig.width=9}
future_comp_bin <- ggplot() +
  geom_raster(data = stud_bin_fut_df,
              aes(x = x, y = y, fill = ensemble)) +
  geom_sf(data = world,
          color = "black") +
  geom_sf(data = bathy_200, fill = NA) +
  scale_fill_gradient2(breaks = seq(0, 1, by = 1),
                       labels = c("None", "High")) +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 1.3) +
  coord_sf(xlim = c(-120, -20),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "Suitability",
       title = "Binary map S. tudes Future prediction RCP 4.5") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```

```{r, fig.height=9, fig.width=9}
pres_com_bin <- ggplot() +
  geom_raster(data = stud_bin_pres_comp_df,
              aes(x = x, y = y, fill = ensemble),
              show.legend = F) +
  geom_sf(data = world,
          color = "black") +
  geom_sf(data = bathy_200, fill = NA) +

  scale_fill_gradient2() +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 1.3) +
  coord_sf(xlim = c(-120, -20),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       title = "Binary map S. tudes present") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```


```{r, fig.height=9, fig.width=9}
future_comp <-
  ggplot() +
  geom_raster(data = stud_prob_fut_df, 
            aes(x = x, y = y, fill = ensemble)) +
  geom_sf(data = world) +
  geom_sf(data = bathy_200, fill = NA,
          color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 1.3) +
  scale_fill_viridis_c(breaks = seq(0, 12, by = 12),
                       labels = c("Low", "High")) +
  coord_sf(xlim = c(-120, -20),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "Suitability",
       title = "Probability map S. tudes Future") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```

```{r, fig.height=9, fig.width=9}
present_comp <- ggplot() +
  geom_raster(data = stud_prob_pres_comp_df, 
            aes(x = x, y = y, fill = ensemble),
            show.legend = F) +
  geom_sf(data = world) +
  geom_sf(data = bathy_200, fill = NA,
          color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 1.3) +
  scale_fill_viridis_c() +
  coord_sf(xlim = c(-120, -20),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       title = "Probability map S. tudes present") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```

```{r, fig.height=11, fig.width=11}
(pres_com_bin + future_comp_bin) /
  (present_comp + future_comp) +
  plot_layout(widths = c(3,3),
              heights = c(3,3))

ggsave(here::here("data", "outputs", "composite_figures_for_present_and_future_maps_for_comparison.png"),
       width = 11, height = 11, dpi = 300)

ggsave(here::here("data", "outputs", "composite_figures_for_present_and_future_maps_for_comparison.tiff"), 
       width = 11, height = 11, compression = "lzw", dpi = 300)
```

```{r, fig.height=9, fig.width=9}
future_comp_zoom <- 
  ggplot() +
  geom_raster(data = stud_prob_fut_df, 
            aes(x = x, y = y, fill = ensemble)) +
  geom_sf(data = world) +
  geom_sf(data = bathy_200, fill = NA,
          color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 2) +
  scale_fill_viridis_c(breaks = seq(0, 12, by = 12),
                       labels = c("Low", "High")) +
  coord_sf(xlim = c(-80, -30),
           ylim = c(-10, 20),
           expand = FALSE) +
  labs(x = "",
       y = "",
       title = "Probability map S. tudes Future",
       fill = "Probability of occurrence") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```


```{r, fig.height=9, fig.width=9}
pres_comp_zoom <- 
  ggplot() +
  geom_raster(data = stud_prob_pres_comp_df,
              aes(x = x, y = y, fill = ensemble),
            show.legend = F) +
  geom_sf(data = world) +
  geom_sf(data = bathy_200,
          fill = NA,
          color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.8,
             size = 2) +
  scale_fill_viridis_c() +
  coord_sf(xlim = c(-80, -30),
           ylim = c(-10, 20),
           expand = FALSE) +
  labs(x = "",
       y = "",
       title = "Probability map S. tudes present",
       fill = "Probability of occurrence") +
  theme_bw() +
  theme(axis.text = element_text(color = "black", size = 11))
```


```{r, fig.height=9, fig.width=9}
pres_comp_zoom / 
  future_comp_zoom

ggsave(here::here("data", "outputs", "composite_figures_for_suitability_pres_and_future_zoom.png"),
       width = 11, height = 11, dpi = 300)

ggsave(here::here("data", "outputs", "composite_figures_for_suitability_pres_and_future_zoom.tiff"), 
       width = 10, height = 10, compression = "lzw", dpi = 300)
```


```{r}
bin_pres <-
  ggplot() +
  geom_raster(data = stud_bin_pres_df,
              aes(x = x, y = y, fill = factor(ensemble))) +
  geom_sf(data = world) +
  # geom_sf(data = bathy_200,
  #         fill = NA,
  #         color = "black") +
   geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.5,
             size = 1.5) +
    geom_text() +
  annotate("text", label = "A",
           x = -104, y = 46, size = 5, color = "black") +
  scale_fill_manual(values = c("white", "#005AB5"),
                    labels = c("Not suitable", "Suitable")) +
  coord_sf(xlim = c(-108, -25),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.key = element_rect(color = "black", size = 1),
        legend.position = c(.2, .2),
        legend.background = element_rect(fill = "transparent"))
```



```{r}
prob_pres <- 
  ggplot() +
  geom_raster(data = stud_prob_pres_df, 
            aes(x = x, y = y, fill = ensemble)) +
  geom_sf(data = world) +
  # geom_sf(data = bathy_200, fill = NA,
  #         color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.5,
             size = 1.5) +
  geom_text() +
  annotate("text", label = "B",
           x = -104, y = 46, size = 5, color = "black") +
  scale_fill_viridis_c(breaks = seq(0, 18, by = 16),
                       labels = c("Low", "High")) +
  coord_sf(xlim = c(-108, -25),
           ylim = c(-60, 50),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "Suitability") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(.15, .2),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white")) +
  guides(fill = guide_colourbar(ticks = F,
                                barwidth = 0.8))
```


```{r}
prob_pres_zoom <- 
  ggplot() +
  geom_sf(data = world) +
  geom_raster(data = stud_prob_pres_df, 
            aes(x = x, y = y, fill = ensemble)) +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             fill = "maroon2",
             color = "black",
             alpha = 0.5,
             size = 1.5) +
  scale_fill_viridis_c(breaks = seq(0, 18, by = 17),
                       labels = c("Low", "High")) +
  coord_sf(xlim = c(-80, -30),
           ylim = c(-10, 20),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "Suitability") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(.88, .75),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white")) +
  guides(fill = guide_colorbar(ticks = F,
                               barwidth = 0.8))
```

```{r}
bin_pres_zoom <- 
  ggplot() +
  geom_raster(data = stud_bin_pres_df, 
            aes(x = x, y = y, fill = factor(ensemble))) +
  geom_sf(data = world,
           color = "black") +
  # geom_sf(data = bathy_200,
  #         fill = NA,
  #         color = "black") +
  geom_point(data = ocor, 
             aes(x = long, y = lat),
             pch = 21,
             color = "black",
             fill = "maroon2",
             alpha = 0.5,
             size = 1.5) +
  scale_fill_manual(values = c("white", "#005AB5"),
                    labels = c("Not suitable", "Suitable")) +
  coord_sf(xlim = c(-80, -30),
           ylim = c(-10, 20),
           expand = FALSE) +
  labs(x = "",
       y = "",
       fill = "") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.key = element_rect(color = "black", size = 1),
        legend.position = c(.88, .75))
```


```{r, fig.height=9, fig.width=9}
bin_pres +
  prob_pres 

ggsave(file.path(outdir, "composite_of_present_models_with_all_vars.png"),
       width = 11, height = 9, dpi = 300)

#ggsave(here::here("data", "outputs", "composite_of_present_models_with_all_vars.tiff"), width = 10, height = 10, compression = "lzw", dpi = 300)
```


```{r, fig.height=9, fig.width=9}
bin_pres_zoom /
  prob_pres_zoom +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag.position = c(0, 1.02))

ggsave(file.path(outdir, "zoom_composite_of_present_models_with_all_vars.png"),
       width = 11, height = 9, dpi = 300)
```


































